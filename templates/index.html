<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monkey Ultimate Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #323437; --main: #e2b714; --sub: #646669; --text: #d1d0c5; --err: #ca4754; --box: #2c2e31; }
        body { background: var(--bg); color: var(--text); font-family: 'Roboto Mono', monospace; margin: 0; height: 100vh; overflow: hidden; display: flex; user-select: none; }

        /* --- UI COMPONENTS --- */
        .btn-icon { background: transparent; border: none; color: var(--sub); font-size: 18px; cursor: pointer; padding: 10px; transition: 0.2s; }
        .btn-icon:hover, .btn-icon.active { color: var(--main); }
        
        .toolbar { display: flex; gap: 20px; margin-bottom: 30px; background: #252525; padding: 10px 30px; border-radius: 8px; font-size: 14px; }
        .tool-group { display: flex; gap: 10px; align-items: center; border-right: 1px solid #444; padding-right: 20px; }
        .tool-group:last-child { border: none; }
        .tool-item { cursor: pointer; color: var(--sub); }
        .tool-item:hover, .tool-item.active { color: var(--main); font-weight: bold; }

        /* --- LOGIN --- */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: var(--box); padding: 40px; border-radius: 10px; border: 2px solid var(--main); text-align: center; width: 350px; }
        .auth-box input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #555; color: #fff; font-family: inherit; }
        .auth-box button { width: 100%; padding: 10px; cursor: pointer; margin-top: 10px; font-weight: bold; }

        /* --- SIDEBAR --- */
        #sidebar { width: 260px; background: #252525; border-right: 1px solid #444; display: flex; flex-direction: column; transition: 0.3s; z-index: 10; }
        .user-info { padding: 20px; border-bottom: 1px solid #444; text-align: center; }
        .song-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .song-item { padding: 10px; color: var(--sub); cursor: pointer; border-radius: 4px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-item:hover { background: #333; color: var(--main); }

        /* --- MAIN --- */
        #main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .logo { font-size: 20px; color: var(--sub); margin-bottom: 20px; }
        .logo span { color: var(--main); }

        /* SEARCH & LIST RESULT */
        #search-box input { background: transparent; border: none; border-bottom: 2px solid var(--sub); color: var(--text); font-size: 24px; padding: 10px; width: 500px; text-align: center; outline: none; }
        #search-results { 
            display: none; position: absolute; top: 60%; width: 500px; background: #222; border: 1px solid var(--main); border-radius: 8px; max-height: 300px; overflow-y: auto; z-index: 50; 
        }
        .search-item { padding: 15px; border-bottom: 1px solid #444; cursor: pointer; display: flex; justify-content: space-between; }
        .search-item:hover { background: #333; color: var(--main); }

        /* GAME UI */
        #game-area { display: none; width: 90%; max-width: 900px; flex-direction: column; align-items: center; }
        #timer-display { font-size: 40px; color: var(--main); margin-bottom: 20px; font-weight: bold; }
        
        #paragraph-display { 
            width: 100%; height: 120px; background: #292929; border-radius: 8px; padding: 20px; font-size: 22px; color: var(--sub); overflow: hidden; position: relative; text-align: left; line-height: 1.6; margin-bottom: 20px; 
        }
        #paragraph-display::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; background: linear-gradient(transparent, #292929); }
        .word { display: inline-block; margin-right: 10px; padding: 2px 5px; opacity: 0.6; }
        .word.active { opacity: 1; color: #fff; background: #444; }
        .word.done-correct { color: var(--main); opacity: 1; }
        .word.done-wrong { color: var(--err); text-decoration: line-through; opacity: 1; }

        #input-container { width: 350px; height: 60px; background: var(--box); border: 2px solid var(--main); border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px rgba(226,183,20,0.1); margin-bottom: 20px; }
        #typing-display { font-size: 28px; font-weight: bold; color: var(--text); }
        #hiddenInput { opacity: 0; position: absolute; }

        /* KEYBOARD */
        #keyboard { transform: scale(0.9); display: flex; flex-direction: column; gap: 5px; align-items: center; }
        .kb-row { display: flex; gap: 5px; }
        .key { width: 45px; height: 45px; border: 1px solid var(--sub); border-radius: 5px; color: var(--sub); display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.05s; }
        .key.pressed { background: var(--main); color: #222; border-color: var(--main); transform: translateY(3px); }
        .key.space { width: 250px; }

        /* RESULT */
        #result-screen { position: absolute; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:100; display:none; flex-direction:column; justify-content:center; align-items:center; }
        .chart-box { width: 700px; height: 350px; background:#292929; padding:20px; border-radius:10px; margin-top:20px; }
        .stat-val { font-size: 60px; color: var(--main); font-weight: bold; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-box">
        <h2 style="color:var(--main)">MONKEY CLOUD</h2>
        <input type="text" id="user" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button onclick="auth('login')" style="background:var(--main); border:none;">LOGIN</button>
        <button onclick="auth('register')" style="background:transparent; border:1px solid var(--sub); color:var(--text);">REGISTER</button>
        <p id="auth-msg" style="color:var(--err); margin-top:10px;"></p>
    </div>
</div>

<div id="sidebar">
    <div class="user-info">
        <i class="fas fa-user-circle" style="font-size:40px; color:var(--sub)"></i>
        <div id="display-user" style="margin-top:10px; font-weight:bold">Guest</div>
    </div>
    <div class="song-list" id="saved-list"></div>
    <button onclick="location.reload()" style="padding:15px; background:#ca4754; color:white; border:none; cursor:pointer;">LOGOUT</button>
</div>

<div id="main">
    <div class="logo">dành riêng cho <span>Nguyễn Thị Phương</span> ❤️</div>

    <div class="toolbar" id="toolbar">
        <div class="tool-group">
            <span class="tool-item active" onclick="setMode('lyrics', this)"><i class="fas fa-music"></i> Lyrics</span>
            <span class="tool-item" onclick="setMode('quote', this)"><i class="fas fa-quote-right"></i> Quote</span>
        </div>
        <div class="tool-group">
            <span class="tool-item" onclick="setTime(15, this)">15</span>
            <span class="tool-item" onclick="setTime(30, this)">30</span>
            <span class="tool-item active" onclick="setTime(60, this)">60</span>
            <span class="tool-item" onclick="setTime(120, this)">120</span>
            <span class="tool-item" onclick="setTime(180, this)">180</span>
        </div>
    </div>

    <div id="search-box">
        <input type="text" id="songQuery" placeholder="Nhập tên bài hát..." autocomplete="off">
        <p id="statusMsg" style="color:var(--main); margin-top:10px;"></p>
        <div id="search-results"></div>
    </div>

    <div id="game-area">
        <div id="timer-display">60</div>
        <h3 id="contentTitle" style="color:var(--sub)"></h3>
        
        <div id="paragraph-display"></div>
        <div id="input-container" onclick="hiddenInput.focus()">
            <span id="typing-display"></span>
        </div>
        
        <input type="text" id="hiddenInput" autocomplete="off">
        
        <div id="keyboard">
            <div class="kb-row"><div class="key" data-c="Backquote">`</div><div class="key" data-c="Digit1">1</div><div class="key" data-c="Digit2">2</div><div class="key" data-c="Digit3">3</div><div class="key" data-c="Digit4">4</div><div class="key" data-c="Digit5">5</div><div class="key" data-c="Digit6">6</div><div class="key" data-c="Digit7">7</div><div class="key" data-c="Digit8">8</div><div class="key" data-c="Digit9">9</div><div class="key" data-c="Digit0">0</div><div class="key" data-c="Minus">-</div><div class="key" data-c="Equal">=</div><div class="key" style="width:70px">Back</div></div>
            <div class="kb-row"><div class="key" style="width:60px">Tab</div><div class="key" data-c="KeyQ">Q</div><div class="key" data-c="KeyW">W</div><div class="key" data-c="KeyE">E</div><div class="key" data-c="KeyR">R</div><div class="key" data-c="KeyT">T</div><div class="key" data-c="KeyY">Y</div><div class="key" data-c="KeyU">U</div><div class="key" data-c="KeyI">I</div><div class="key" data-c="KeyO">O</div><div class="key" data-c="KeyP">P</div><div class="key" data-c="BracketLeft">[</div><div class="key" data-c="BracketRight">]</div><div class="key" data-c="Backslash">\</div></div>
            <div class="kb-row"><div class="key" style="width:70px">Caps</div><div class="key" data-c="KeyA">A</div><div class="key" data-c="KeyS">S</div><div class="key" data-c="KeyD">D</div><div class="key" data-c="KeyF">F</div><div class="key" data-c="KeyG">G</div><div class="key" data-c="KeyH">H</div><div class="key" data-c="KeyJ">J</div><div class="key" data-c="KeyK">K</div><div class="key" data-c="KeyL">L</div><div class="key" data-c="Semicolon">;</div><div class="key" data-c="Quote">'</div><div class="key" style="width:90px">Enter</div></div>
            <div class="kb-row"><div class="key" style="width:90px">Shift</div><div class="key" data-c="KeyZ">Z</div><div class="key" data-c="KeyX">X</div><div class="key" data-c="KeyC">C</div><div class="key" data-c="KeyV">V</div><div class="key" data-c="KeyB">B</div><div class="key" data-c="KeyN">N</div><div class="key" data-c="KeyM">M</div><div class="key" data-c="Comma">,</div><div class="key" data-c="Period">.</div><div class="key" data-c="Slash">/</div><div class="key" style="width:90px">Shift</div></div>
            <div class="kb-row"><div class="key space" data-c="Space">Space</div></div>
        </div>
    </div>

    <div id="result-screen">
        <div style="display:flex; gap:50px;">
            <div><div style="color:var(--sub)">wpm</div><div class="stat-val" id="res-wpm">0</div></div>
            <div><div style="color:var(--sub)">acc</div><div class="stat-val" id="res-acc">0%</div></div>
        </div>
        <div class="chart-box"><canvas id="wpmChart"></canvas></div>
        <button onclick="location.reload()" style="margin-top:20px; padding:10px 30px; background:var(--main); border:none; font-weight:bold; cursor:pointer;">AGAIN</button>
    </div>
</div>

<script>
    // --- VARIABLES ---
    let currentUser = null;
    let allWords = [];
    let currentWordIdx = 0;
    let gameMode = 'lyrics'; // lyrics | quote
    let timeLimit = 60;
    let timerInterval = null;
    let timeLeft = 60;
    
    let isPlaying = false;
    let startTime = 0;
    let totalCorrectChars = 0;
    let totalWrongChars = 0;
    let wpmHistory = [], labels = [], chartInterval = null;

    const hiddenInput = document.getElementById('hiddenInput');
    const typingDisplay = document.getElementById('typing-display');
    const paragraphDiv = document.getElementById('paragraph-display');

    // --- SETUP ---
    function setMode(mode, el) {
        gameMode = mode;
        document.querySelectorAll('.tool-group:first-child .tool-item').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        
        if(mode === 'quote') {
            document.getElementById('search-box').style.display = 'none';
            document.getElementById('statusMsg').innerText = "Đang lấy trích dẫn...";
            fetchQuote();
        } else {
            document.getElementById('search-box').style.display = 'block';
            document.getElementById('game-area').style.display = 'none';
        }
    }

    function setTime(time, el) {
        timeLimit = time;
        timeLeft = time;
        document.getElementById('timer-display').innerText = time;
        document.querySelectorAll('.tool-group:last-child .tool-item').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
    }

    // --- AUTH ---
    async function auth(action) {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const msg = document.getElementById('auth-msg');
        if(!u || !p) return; msg.innerText = "Loading...";
        try {
            const res = await fetch('/api/auth', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action, username:u, password:p}) });
            const data = await res.json();
            if(data.success) {
                if(action==='register') msg.innerText = "OK! Login now.";
                else { currentUser = u; document.getElementById('display-user').innerText = u; document.getElementById('auth-overlay').style.display = 'none'; loadSongs(); }
            } else msg.innerText = data.error;
        } catch(e) { msg.innerText = "Error"; }
    }
    
    async function loadSongs() {
        const res = await fetch('/api/my-songs', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:currentUser}) });
        const songs = await res.json();
        const list = document.getElementById('saved-list');
        list.innerHTML = '';
        songs.forEach(s => {
            const div = document.createElement('div');
            div.className = 'song-item'; div.innerText = s.title;
            div.onclick = () => startGame(s.title, s.lrc);
            list.appendChild(div);
        });
    }

    // --- SEARCH & SELECT ---
    document.getElementById('songQuery').addEventListener('keypress', async (e) => {
        if(e.key === 'Enter') {
            const query = e.target.value;
            const status = document.getElementById('statusMsg');
            status.innerText = "Đang tìm trên Youtube...";
            
            const res = await fetch('/search-list', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query}) });
            const list = await res.json();
            
            if(list.error) { status.innerText = list.error; return; }
            
            // Show list
            const resBox = document.getElementById('search-results');
            resBox.innerHTML = '';
            resBox.style.display = 'block';
            
            list.forEach(item => {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `<span>${item.title}</span>`;
                div.onclick = () => fetchLyrics(item.title);
                resBox.appendChild(div);
            });
            status.innerText = "Chọn 1 bài bên dưới:";
        }
    });

    async function fetchLyrics(title) {
        document.getElementById('search-results').style.display = 'none';
        document.getElementById('statusMsg').innerText = "Đang tải lời bài hát...";
        const res = await fetch('/get-lyrics', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title, username:currentUser}) });
        const data = await res.json();
        if(data.error) document.getElementById('statusMsg').innerText = data.error;
        else {
            loadSongs(); 
            startGame(data.title, data.lrc);
        }
    }

    async function fetchQuote() {
        const res = await fetch('/get-quote');
        const data = await res.json();
        startGame("Quote by " + data.author, data.content);
    }

    // --- GAME ENGINE ---
    function startGame(title, text) {
        document.getElementById('search-box').style.display = 'none';
        document.getElementById('toolbar').style.display = 'none';
        document.getElementById('game-area').style.display = 'flex';
        document.getElementById('contentTitle').innerText = title;
        document.getElementById('timer-display').innerText = timeLimit;
        
        const cleanText = text.replace(/\[.*?\]/g, ' ');
        allWords = cleanText.split(/\s+/).filter(w => w.length > 0);
        
        paragraphDiv.innerHTML = '';
        allWords.forEach((w, i) => {
            const s = document.createElement('span');
            s.className = 'word'; s.innerText = w; s.id = `w-${i}`;
            if(i===0) s.classList.add('active');
            paragraphDiv.appendChild(s);
        });
        
        currentWordIdx = 0; totalCorrectChars = 0; totalWrongChars = 0;
        hiddenInput.value = ''; typingDisplay.innerText = '';
        hiddenInput.focus();
    }

    document.addEventListener('click', () => { if(document.getElementById('game-area').style.display==='flex') hiddenInput.focus(); });

    hiddenInput.addEventListener('input', () => {
        if(!isPlaying) { 
            isPlaying = true; startTime = Date.now(); 
            startChart(); startTimer(); 
        }

        let val = hiddenInput.value;
        if(val.includes(' ')) {
            const spaceIdx = val.indexOf(' ');
            const wordToSubmit = val.substring(0, spaceIdx);
            const remaining = val.substring(spaceIdx + 1);
            
            if(wordToSubmit.length >= 0) {
                const target = allWords[currentWordIdx];
                const el = document.getElementById(`w-${currentWordIdx}`);
                if(wordToSubmit.toLowerCase() === target.toLowerCase()) {
                    el.className = 'word done-correct'; totalCorrectChars += target.length + 1;
                } else {
                    el.className = 'word done-wrong'; totalWrongChars += target.length;
                }
                
                currentWordIdx++;
                if(currentWordIdx >= allWords.length) finishGame();
                else {
                    const next = document.getElementById(`w-${currentWordIdx}`);
                    next.classList.add('active');
                    if(next.offsetTop > paragraphDiv.scrollTop + 80) paragraphDiv.scrollTop = next.offsetTop - 40;
                }
            }
            hiddenInput.value = remaining; typingDisplay.innerText = remaining; checkColor(remaining);
        } else {
            typingDisplay.innerText = val; checkColor(val);
        }
    });

    function checkColor(val) {
        if(currentWordIdx>=allWords.length) return;
        const target = allWords[currentWordIdx];
        typingDisplay.style.color = target.toLowerCase().startsWith(val.toLowerCase()) ? '#e2b714' : '#ca4754';
    }

    // --- TIMING & CHART ---
    function startTimer() {
        timeLeft = timeLimit;
        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('timer-display').innerText = timeLeft;
            if(timeLeft <= 0) finishGame();
        }, 1000);
    }

    function startChart() {
        chartInterval = setInterval(() => {
            const m = (Date.now() - startTime)/60000;
            if(m>0) {
                const wpm = Math.round((totalCorrectChars/5)/m);
                wpmHistory.push(wpm); labels.push(Math.round(m*60));
            }
        }, 1000);
    }

    function finishGame() {
        clearInterval(chartInterval); clearInterval(timerInterval);
        const m = (Date.now() - startTime)/60000;
        const wpm = Math.round((totalCorrectChars/5)/m);
        const acc = Math.round((totalCorrectChars/(totalCorrectChars+totalWrongChars))*100);
        
        document.getElementById('game-area').style.display = 'none';
        document.getElementById('result-screen').style.display = 'flex';
        document.getElementById('res-wpm').innerText = wpm;
        document.getElementById('res-acc').innerText = isNaN(acc) ? "0%" : acc+"%";
        
        new Chart(document.getElementById('wpmChart'), {
            type: 'line', data: { labels: labels, datasets: [{ label: 'WPM', data: wpmHistory, borderColor: '#e2b714', backgroundColor: 'rgba(226,183,20,0.1)', fill: true, tension: 0.4 }] },
            options: { plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#444'}}, y:{grid:{color:'#444'}}} }
        });
    }
    
    document.addEventListener('keydown', (e) => {
        const k = document.querySelector(`.key[data-c="${e.code}"]`);
        if(k) k.classList.add('pressed');
    });
    document.addEventListener('keyup', (e) => {
        const k = document.querySelector(`.key[data-c="${e.code}"]`);
        if(k) k.classList.remove('pressed');
    });
</script>
</body>
</html>