<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monkey Lyrics Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg: #323437; --main: #e2b714; --sub: #646669; --text: #d1d0c5; --err: #ca4754; --box: #2c2e31; }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Roboto Mono', monospace; margin: 0; height: 100vh; overflow: hidden; display: flex; }

        /* --- LOGIN MODAL --- */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999;
            background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center;
        }
        .auth-box { background: var(--box); padding: 40px; border-radius: 15px; border: 2px solid var(--main); text-align: center; width: 350px; }
        .auth-box input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #555; color: #fff; font-family: inherit; border-radius: 5px; }
        .auth-box button { width: 100%; padding: 12px; margin-top: 10px; cursor: pointer; font-weight: bold; border-radius: 5px; border: none; }
        .btn-login { background: var(--main); color: #000; }
        .btn-reg { background: transparent; border: 1px solid var(--sub) !important; color: var(--sub); }
        .btn-reg:hover { color: var(--text); border-color: var(--text) !important; }

        /* --- SIDEBAR (SONG LIST) --- */
        #sidebar {
            width: 260px; background: #252525; border-right: 1px solid #444; display: flex; flex-direction: column;
            transition: 0.3s; position: relative; z-index: 10;
        }
        .user-info { padding: 20px; border-bottom: 1px solid #444; text-align: center; }
        .song-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .song-item { padding: 12px; color: var(--sub); cursor: pointer; border-radius: 5px; margin-bottom: 5px; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .song-item:hover { background: #333; color: var(--main); padding-left: 20px; }
        .logout-btn { padding: 15px; background: #ca4754; color: white; border: none; cursor: pointer; font-weight: bold; }

        /* --- MAIN AREA --- */
        #main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        .logo { font-size: 20px; color: var(--sub); margin-bottom: 30px; }
        .logo span { color: var(--main); }

        /* SEARCH */
        #search-box input {
            background: transparent; border: none; border-bottom: 2px solid var(--sub);
            color: var(--text); font-size: 28px; padding: 10px; width: 500px; text-align: center; outline: none;
        }

        /* GAME UI */
        #game-area { display: none; width: 90%; max-width: 1000px; flex-direction: column; align-items: center; }
        
        /* Paragraph Display */
        #paragraph-display {
            width: 100%; height: 120px; background: #292929; border-radius: 8px; padding: 20px;
            font-size: 24px; color: var(--sub); overflow: hidden; position: relative;
            text-align: left; line-height: 1.6; margin-bottom: 20px;
        }
        #paragraph-display::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; background: linear-gradient(transparent, #292929); }
        
        .word { display: inline-block; margin-right: 10px; padding: 2px 5px; border-radius: 4px; opacity: 0.6; }
        .word.active { opacity: 1; color: #fff; background: #444; transform: scale(1.1); font-weight: bold; }
        .word.done-correct { color: var(--main); opacity: 1; }
        .word.done-wrong { color: var(--err); text-decoration: line-through; opacity: 1; }

        /* Input Box */
        #input-container {
            width: 350px; height: 60px; background: var(--box); border: 2px solid var(--main);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(226, 183, 20, 0.15); margin-bottom: 30px;
        }
        #typing-display { font-size: 32px; font-weight: bold; color: var(--text); white-space: pre; }

        /* Keyboard */
        #keyboard { transform: scale(0.9); display: flex; flex-direction: column; gap: 5px; align-items: center; }
        .kb-row { display: flex; gap: 5px; }
        .key { width: 45px; height: 45px; border: 1px solid var(--sub); border-radius: 5px; color: var(--sub); display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.05s; }
        .key.pressed { background: var(--main); color: #222; border-color: var(--main); transform: translateY(3px); }
        .key.space { width: 250px; }

        /* Report Screen */
        #result-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 50;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .chart-container { width: 800px; height: 400px; background: #292929; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .big-stat { font-size: 80px; color: var(--main); font-weight: bold; }
        .stat-label { font-size: 20px; color: var(--sub); }
        .btn-restart { margin-top: 20px; padding: 12px 30px; background: var(--sub); border: none; color: #fff; font-size: 18px; cursor: pointer; border-radius: 5px; }
        .btn-restart:hover { background: var(--main); color: #000; }

        #hiddenInput { opacity: 0; position: absolute; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-box">
        <h2 style="color:var(--main)">MONKEY CLOUD</h2>
        <p style="color:var(--sub); font-size:14px;">Dành riêng cho <b>Nguyễn Thị Phương</b> ❤️</p>
        <input type="text" id="user" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button class="btn-login" onclick="auth('login')">LOGIN</button>
        <button class="btn-reg" onclick="auth('register')">REGISTER</button>
        <p id="auth-msg" style="color:var(--err); margin-top:10px; font-size:13px;"></p>
    </div>
</div>

<div id="sidebar">
    <div class="user-info">
        <div style="font-size: 40px; color: var(--sub);"><i class="fas fa-user-circle"></i></div>
        <div id="display-username" style="margin-top:10px; font-weight:bold; color:var(--text)">Guest</div>
    </div>
    <div class="song-list" id="saved-list">
        </div>
    <button class="logout-btn" onclick="location.reload()">LOG OUT</button>
</div>

<div id="main">
    <div class="logo">dành riêng cho <span>Nguyễn Thị Phương</span> ❤️</div>

    <div id="search-box">
        <input type="text" id="songQuery" placeholder="Nhập tên bài hát (VD: Em Cưới Rồi)..." autocomplete="off">
        <p id="statusMsg" style="color:var(--main); margin-top:10px;"></p>
    </div>

    <div id="game-area">
        <h2 id="songTitle" style="color:var(--main); margin-bottom:10px;"></h2>
        
        <div id="paragraph-display"></div>
        
        <div id="input-container" onclick="hiddenInput.focus()">
            <span id="typing-display"></span>
        </div>
        
        <input type="text" id="hiddenInput" autocomplete="off">

        <div id="keyboard">
            <div class="kb-row"><div class="key" data-c="Backquote">`</div><div class="key" data-c="Digit1">1</div><div class="key" data-c="Digit2">2</div><div class="key" data-c="Digit3">3</div><div class="key" data-c="Digit4">4</div><div class="key" data-c="Digit5">5</div><div class="key" data-c="Digit6">6</div><div class="key" data-c="Digit7">7</div><div class="key" data-c="Digit8">8</div><div class="key" data-c="Digit9">9</div><div class="key" data-c="Digit0">0</div><div class="key" data-c="Minus">-</div><div class="key" data-c="Equal">=</div><div class="key" style="width:70px">Back</div></div>
            <div class="kb-row"><div class="key" style="width:60px">Tab</div><div class="key" data-c="KeyQ">Q</div><div class="key" data-c="KeyW">W</div><div class="key" data-c="KeyE">E</div><div class="key" data-c="KeyR">R</div><div class="key" data-c="KeyT">T</div><div class="key" data-c="KeyY">Y</div><div class="key" data-c="KeyU">U</div><div class="key" data-c="KeyI">I</div><div class="key" data-c="KeyO">O</div><div class="key" data-c="KeyP">P</div><div class="key" data-c="BracketLeft">[</div><div class="key" data-c="BracketRight">]</div><div class="key" data-c="Backslash">\</div></div>
            <div class="kb-row"><div class="key" style="width:70px">Caps</div><div class="key" data-c="KeyA">A</div><div class="key" data-c="KeyS">S</div><div class="key" data-c="KeyD">D</div><div class="key" data-c="KeyF">F</div><div class="key" data-c="KeyG">G</div><div class="key" data-c="KeyH">H</div><div class="key" data-c="KeyJ">J</div><div class="key" data-c="KeyK">K</div><div class="key" data-c="KeyL">L</div><div class="key" data-c="Semicolon">;</div><div class="key" data-c="Quote">'</div><div class="key" style="width:90px">Enter</div></div>
            <div class="kb-row"><div class="key" style="width:90px">Shift</div><div class="key" data-c="KeyZ">Z</div><div class="key" data-c="KeyX">X</div><div class="key" data-c="KeyC">C</div><div class="key" data-c="KeyV">V</div><div class="key" data-c="KeyB">B</div><div class="key" data-c="KeyN">N</div><div class="key" data-c="KeyM">M</div><div class="key" data-c="Comma">,</div><div class="key" data-c="Period">.</div><div class="key" data-c="Slash">/</div><div class="key" style="width:90px">Shift</div></div>
            <div class="kb-row"><div class="key space" data-c="Space">Space</div></div>
        </div>
    </div>

    <div id="result-screen">
        <div class="stat-label">wpm</div>
        <div class="big-stat" id="res-wpm">0</div>
        <div class="stat-label">acc</div>
        <div class="big-stat" id="res-acc" style="font-size:40px; color:#fff">0%</div>
        
        <div class="chart-container">
            <canvas id="wpmChart"></canvas>
        </div>
        
        <button class="btn-restart" onclick="location.reload()">Next Song</button>
    </div>
</div>

<script>
    let currentUser = null;
    let allWords = [];
    let currentWordIdx = 0;
    let startTime = 0;
    let isPlaying = false;
    let totalCorrectChars = 0;
    let totalWrongChars = 0;
    let wpmHistory = [], labels = [], chartInterval = null;
    
    const hiddenInput = document.getElementById('hiddenInput');
    const typingDisplay = document.getElementById('typing-display');
    const paragraphDiv = document.getElementById('paragraph-display');

    // --- 1. AUTH LOGIC ---
    async function auth(action) {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const msg = document.getElementById('auth-msg');
        
        if(!u || !p) { msg.innerText = "Please fill all fields"; return; }
        msg.innerText = "Processing...";

        try {
            const res = await fetch('/api/auth', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({action, username: u, password: p})
            });
            const data = await res.json();
            
            if(data.success) {
                if(action === 'register') { msg.innerText = "Registered! Please login."; }
                else {
                    currentUser = u;
                    document.getElementById('display-username').innerText = u;
                    document.getElementById('auth-overlay').style.display = 'none';
                    loadSongs();
                }
            } else { msg.innerText = data.error; }
        } catch(e) { msg.innerText = "Server Error"; }
    }

    async function loadSongs() {
        const res = await fetch('/api/my-songs', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({username: currentUser})
        });
        const songs = await res.json();
        const list = document.getElementById('saved-list');
        list.innerHTML = '';
        songs.forEach(s => {
            const div = document.createElement('div');
            div.className = 'song-item';
            div.innerText = s.title;
            div.onclick = () => initGame(s.title, s.lrc);
            list.appendChild(div);
        });
    }

    // --- 2. SEARCH & INIT GAME ---
    document.getElementById('songQuery').addEventListener('keypress', async (e) => {
        if(e.key === 'Enter') {
            const query = e.target.value;
            document.getElementById('statusMsg').innerText = "Searching & Saving...";
            
            const res = await fetch('/get-song', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({query: query, username: currentUser})
            });
            const data = await res.json();
            
            if(data.error) document.getElementById('statusMsg').innerText = data.error;
            else {
                loadSongs(); // Refresh list
                initGame(data.title, data.lrc);
            }
        }
    });

    function initGame(title, lrc) {
        document.getElementById('search-box').style.display = 'none';
        document.getElementById('game-area').style.display = 'flex';
        document.getElementById('songTitle').innerText = title;
        
        const cleanText = lrc.replace(/\[.*?\]/g, ' ');
        allWords = cleanText.split(/\s+/).filter(w => w.length > 0);
        
        paragraphDiv.innerHTML = '';
        allWords.forEach((w, i) => {
            const s = document.createElement('span');
            s.className = 'word'; s.innerText = w; s.id = `w-${i}`;
            if(i===0) s.classList.add('active');
            paragraphDiv.appendChild(s);
        });
        hiddenInput.focus();
    }

    // --- 3. TYPING ENGINE ---
    document.addEventListener('click', () => { if(document.getElementById('game-area').style.display === 'flex') hiddenInput.focus(); });
    
    hiddenInput.addEventListener('input', (e) => {
        if(!isPlaying) { isPlaying = true; startTime = Date.now(); startChart(); }
        
        let val = hiddenInput.value;
        
        // Handle Space (Cut word)
        if(val.includes(' ')) {
            const spaceIdx = val.indexOf(' ');
            const wordToSubmit = val.substring(0, spaceIdx);
            const remaining = val.substring(spaceIdx + 1);
            
            if(wordToSubmit.length >= 0) {
                const target = allWords[currentWordIdx];
                const el = document.getElementById(`w-${currentWordIdx}`);
                
                if(wordToSubmit.toLowerCase() === target.toLowerCase()) {
                    el.className = 'word done-correct';
                    totalCorrectChars += target.length + 1;
                } else {
                    el.className = 'word done-wrong';
                    totalWrongChars += target.length;
                }
                
                currentWordIdx++;
                if(currentWordIdx >= allWords.length) finishGame();
                else {
                    const next = document.getElementById(`w-${currentWordIdx}`);
                    next.classList.add('active');
                    if(next.offsetTop > paragraphDiv.scrollTop + 80) paragraphDiv.scrollTop = next.offsetTop - 40;
                }
            }
            hiddenInput.value = remaining;
            typingDisplay.innerText = remaining;
            checkColor(remaining);
        } else {
            typingDisplay.innerText = val;
            checkColor(val);
        }
    });

    function checkColor(val) {
        if(currentWordIdx >= allWords.length) return;
        const target = allWords[currentWordIdx];
        if(target.toLowerCase().startsWith(val.toLowerCase())) typingDisplay.style.color = '#e2b714';
        else typingDisplay.style.color = '#ca4754';
    }

    // --- 4. KEYBOARD & CHART ---
    document.addEventListener('keydown', (e) => {
        const k = document.querySelector(`.key[data-c="${e.code}"]`);
        if(k) k.classList.add('pressed');
    });
    document.addEventListener('keyup', (e) => {
        const k = document.querySelector(`.key[data-c="${e.code}"]`);
        if(k) k.classList.remove('pressed');
    });

    function startChart() {
        chartInterval = setInterval(() => {
            const m = (Date.now() - startTime)/60000;
            if(m>0) {
                const wpm = Math.round((totalCorrectChars/5)/m);
                wpmHistory.push(wpm);
                labels.push(Math.round(m*60));
            }
        }, 1000);
    }

    function finishGame() {
        clearInterval(chartInterval);
        const m = (Date.now() - startTime)/60000;
        const wpm = Math.round((totalCorrectChars/5)/m);
        const acc = Math.round((totalCorrectChars/(totalCorrectChars+totalWrongChars))*100);
        
        document.getElementById('game-area').style.display = 'none';
        document.getElementById('result-screen').style.display = 'flex';
        document.getElementById('res-wpm').innerText = wpm;
        document.getElementById('res-acc').innerText = acc + "%";
        
        new Chart(document.getElementById('wpmChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: 'WPM', data: wpmHistory, borderColor: '#e2b714', backgroundColor: 'rgba(226,183,20,0.1)', fill: true, tension: 0.4 }]
            },
            options: { plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#444'}}, y:{grid:{color:'#444'}}} }
        });
    }
</script>
</body>
</html>