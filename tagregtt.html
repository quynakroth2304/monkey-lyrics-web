<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Typing Game</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #222; color: #fff; text-align: center; padding: 20px; }
        #game-container { max-width: 800px; margin: 0 auto; }
        .lyrics-display { font-size: 24px; margin: 30px 0; min-height: 60px; color: #aaa; transition: all 0.2s; }
        .lyrics-display.active { color: #fff; font-weight: bold; transform: scale(1.1); text-shadow: 0 0 10px #00ffcc; }
        input { padding: 10px; font-size: 18px; width: 80%; border-radius: 5px; border: none; }
        button { padding: 10px 20px; font-size: 18px; cursor: pointer; background: #00ffcc; border: none; border-radius: 5px; font-weight: bold; }
        .status { margin-top: 10px; font-size: 14px; color: #ffcc00; }
        /* Hi·ªáu ·ª©ng g√µ ƒë√∫ng sai */
        .correct { color: #00ff00; }
        .incorrect { color: #ff0000; text-decoration: line-through; }
    </style>
</head>
<body>

<div id="game-container">
    <h1>üéµ Luy·ªán G√µ Theo Nh·∫°c üéµ</h1>
    
    <div id="search-box">
        <input type="text" id="songQuery" placeholder="Nh·∫≠p t√™n b√†i h√°t (VD: Son Tung MTP)...">
        <button onclick="searchSong()">T√¨m & Ch∆°i</button>
    </div>
    <p class="status" id="statusMsg"></p>

    <div id="game-area" style="display:none;">
        <h3 id="songTitle">Loading...</h3>
        <audio id="audioPlayer" controls style="width: 100%; margin: 20px 0;"></audio>
        
        <div id="lyric-box" class="lyrics-display">
            ƒêang ch·ªù nh·∫°c...
        </div>

        <input type="text" id="typingInput" placeholder="G√µ theo l·ªùi nh·∫°c..." autocomplete="off">
        <p>ƒêi·ªÉm: <span id="score">0</span></p>
    </div>
</div>

<script>
    let lrcData = [];
    let currentLineIndex = -1;
    let score = 0;
    const audio = document.getElementById('audioPlayer');
    const lyricBox = document.getElementById('lyric-box');
    const input = document.getElementById('typingInput');

    async function searchSong() {
        const query = document.getElementById('songQuery').value;
        const status = document.getElementById('statusMsg');
        
        if(!query) return alert("Nh·∫≠p t√™n b√†i h√°t ƒëi b·∫°n ∆°i!");
        
        status.innerText = "ƒêang t·∫£i nh·∫°c v√† l·ªùi (c√≥ th·ªÉ m·∫•t 10-20s)...";
        
        try {
            const res = await fetch('/get-song', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({query: query})
            });
            
            const data = await res.json();
            
            if(data.error) {
                status.innerText = "L·ªói: " + data.error;
            } else {
                status.innerText = "";
                setupGame(data);
            }
        } catch (e) {
            status.innerText = "L·ªói k·∫øt n·ªëi server!";
        }
    }

    function setupGame(data) {
        document.getElementById('search-box').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        document.getElementById('songTitle').innerText = data.title;
        
        audio.src = data.audio_url;
        lrcData = parseLRC(data.lrc);
        
        audio.play();
        input.focus();
    }

    // H√†m chuy·ªÉn ƒë·ªïi text LRC th√†nh m·∫£ng Object
    function parseLRC(lrcText) {
        const lines = lrcText.split('\n');
        const result = [];
        const timeReg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;

        lines.forEach(line => {
            const match = timeReg.exec(line);
            if (match) {
                const min = parseInt(match[1]);
                const sec = parseInt(match[2]);
                const ms = parseInt(match[3]);
                const time = min * 60 + sec + (ms / 100);
                const text = line.replace(timeReg, '').trim();
                if(text) result.push({ time, text });
            }
        });
        return result;
    }

    // V√≤ng l·∫∑p ch√≠nh c·ªßa game
    audio.ontimeupdate = () => {
        const time = audio.currentTime;
        
        // T√¨m d√≤ng lyric ph√π h·ª£p v·ªõi th·ªùi gian hi·ªán t·∫°i
        for (let i = 0; i < lrcData.length; i++) {
            if (time >= lrcData[i].time && (i === lrcData.length - 1 || time < lrcData[i+1].time)) {
                if (currentLineIndex !== i) {
                    currentLineIndex = i;
                    updateLyricDisplay(lrcData[i].text);
                }
                break;
            }
        }
    };

    function updateLyricDisplay(text) {
        lyricBox.innerText = text;
        lyricBox.classList.add('active');
        input.value = ''; // Reset √¥ nh·∫≠p khi qua c√¢u m·ªõi
        // ·ªû ƒë√¢y b·∫°n c√≥ th·ªÉ th√™m logic tr·ª´ ƒëi·ªÉm n·∫øu c√¢u tr∆∞·ªõc ch∆∞a g√µ xong
    }

    // Logic ki·ªÉm tra g√µ ph√≠m
    input.addEventListener('input', (e) => {
        if(currentLineIndex === -1) return;
        
        const targetText = lrcData[currentLineIndex].text;
        const userText = e.target.value;

        if (targetText === userText) {
            score += 10;
            document.getElementById('score').innerText = score;
            lyricBox.style.color = '#00ff00'; // Hi·ªáu ·ª©ng ho√†n th√†nh
            input.value = ''; // X√≥a ƒë·ªÉ ƒë·ª£i c√¢u ti·∫øp (ho·∫∑c gi·ªØ l·∫°i t√πy logic b·∫°n mu·ªën)
        } else if (targetText.startsWith(userText)) {
            lyricBox.style.color = '#fff';
        } else {
            lyricBox.style.color = '#ff4444'; // G√µ sai
        }
    });
</script>

</body>
</html>